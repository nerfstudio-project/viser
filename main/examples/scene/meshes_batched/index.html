<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RRGY51J5ZH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-RRGY51J5ZH');
    </script>
    <link rel="index" title="Index" href="../../../genindex/" /><link rel="search" title="Search" href="../../../search/" /><link rel="next" title="Lighting and shadows" href="../lighting/" /><link rel="prev" title="Images" href="../images/" />

    <!-- Generated with Sphinx 8.0.2 and Furo 2024.08.06 -->
        <title>Batched mesh rendering - viser</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=5976cbfc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/ansi.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-code-background: #f4f4f4;
  --color-code-foreground: #000;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../"><div class="brand">viser</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a
  class="sidebar-brand"
  href="../../../"
>
  
  <div class="sidebar-logo-container" style="margin: 0.5rem 1em 0.5rem 0">
    <img
      class="sidebar-logo only-light"
      src="../../../_static/logo.svg"
      alt="logo"
    />
    <img
      class="sidebar-logo only-dark"
      src="../../../_static/logo.svg"
      alt="logo"
    />
  </div>
  <!-- <span class="sidebar-brand-text">Viser</span> -->

  
</a>

<!-- Dropdown for different versions of the viser docs. Slightly hacky. -->
<div style="padding: 0 1em">
  <script>
    var viserDocsVersionsPopulated = false;

    async function getViserVersionList() {
      // This index.txt file is written by the docs.yml GitHub action.
      // https://github.com/nerfstudio-project/viser/blob/main/.github/workflows/docs.yml
      const response = await fetch("https://viser.studio/versions/index.txt", {
        cache: "no-cache",
      });
      return await response.text();
    }
    async function viserDocsPopulateVersionDropDown() {
      // Load the version list lazily...
      if (viserDocsVersionsPopulated) {
        return;
      }
      viserDocsVersionsPopulated = true;

      console.log("Populating docs version list!");
      const versions = (await getViserVersionList())
        .trim()
        .split("\n")
        .reverse();
      console.log(versions);
      let htmlString = "<ul style='margin: 0.5rem 0 0 0'>";
      htmlString += `<li><a href="https://viser.studio/main">main</a></li>`;
      for (let version of versions) {
        htmlString += `<li><a href="https://viser.studio/versions/${version}">${version}</a></li>`;
      }

      htmlString += "</ul>";
      document.getElementById("viser-version-dropdown").innerHTML = htmlString;
    }
  </script>
  <details
    style="
      padding: 0.5rem;
      background: var(--color-background-primary);
      border-radius: 0.5rem;
      border: 1px solid var(--color-sidebar-background-border);
    "
    ontoggle="viserDocsPopulateVersionDropDown()"
  >
    <summary style="cursor: pointer">
      <strong>Version:</strong> <em>main</em>
    </summary>
    <div id="viser-version-dropdown"></div>
  </details>
  <!-- End dropdown -->
</div>

<div style="text-align: left; padding: 1em">
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <a
    class="github-button"
    href="https://github.com/nerfstudio-project/viser"
    data-color-scheme="no-preference: light; light: light; dark: light;"
    data-size="large"
    data-show-count="true"
    aria-label="Download buttons/github-buttons on GitHub"
  >
    Github
  </a>
</div><form class="sidebar-search-container" method="get" action="../../../search/" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../getting_started/">Getting Started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Getting Started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started/hello_world/">Hello world</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started/core_concepts/">Core concepts</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../">Scene Visualization</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Scene Visualization</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../coordinate_frames/">Coordinate frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../point_clouds/">Point cloud visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../meshes/">3D mesh visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lines/">Line visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../images/">Images</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Batched mesh rendering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lighting/">Lighting and shadows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../background_composite/">Depth compositing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../set_up_direction/">Set up direction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gaussian_splats/">Gaussian splats</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../gui/">GUI Controls</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of GUI Controls</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../gui/basic_controls/">Basic GUI controls</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/callbacks/">GUI callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/layouts/">GUI layouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/markdown/">Markdown support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/modals/">Modal dialogs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/theming/">Theming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/notifications/">Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/plotly_integration/">Plotly integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/uplot/">uPlot integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gui/plots_as_images/">Plots as images</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../interaction/">User Interaction</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of User Interaction</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../interaction/click_meshes/">Mesh click events</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interaction/scene_pointer/">Scene pointer events</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interaction/get_renders/">Get renders</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interaction/camera_poses/">Camera pose tracking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interaction/camera_commands/">Programmatic camera control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interaction/gui_in_scene/">3D GUI elements</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../demos/">Demos</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Demos</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../demos/record3d_visualizer/">Record3D</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../demos/colmap_visualizer/">COLMAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../demos/urdf_visualizer/">URDF robot visualizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../demos/smpl_visualizer/">SMPL human model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../demos/smpl_skinned/">SMPL skinned mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../demos/games/">Games</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/core/">Core API</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Core API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core/server/">Viser Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core/scene_api/">Scene API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core/gui_api/">GUI API</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/handles/">Handles API</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Handles API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/handles/client_handles/">Client Handles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/handles/camera_handles/">Camera Handles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/handles/gui_handles/">GUI Handles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/handles/scene_handles/">Scene Handles</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/advanced/">Advanced API</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Advanced API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/advanced/events/">Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/advanced/icons/">Icons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/advanced/theme/">Theme Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/advanced/uplot/">uPlot Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/advanced/state_serializer/">State Serializer</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/auxiliary/">Auxiliary API</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Auxiliary API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/auxiliary/transforms/">Transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/auxiliary/infrastructure/">Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/auxiliary/extras/">Record3D + URDF Helpers</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../conventions/">Frame Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance_tips/">Performance Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../embedded_visualizations/">Embedding Visualizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citation/">Citation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../../_sources/examples/scene/meshes_batched.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="batched-mesh-rendering">
<h1>Batched mesh rendering<a class="headerlink" href="#batched-mesh-rendering" title="Link to this heading">¶</a></h1>
<p>Efficiently render many instances of the same mesh with different transforms and colors.</p>
<p>This example demonstrates batched mesh rendering, which is essential for visualizing large numbers of similar objects like particles, forest scenes, or crowd simulations. Batched rendering is dramatically more efficient than creating individual scene objects.</p>
<p><strong>Key features:</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api/core/scene_api/#viser.SceneApi.add_batched_meshes_simple" title="viser.SceneApi.add_batched_meshes_simple"><code class="xref py py-meth docutils literal notranslate"><span class="pre">viser.SceneApi.add_batched_meshes_simple()</span></code></a> for instanced mesh rendering</p></li>
<li><p><a class="reference internal" href="../../../api/core/scene_api/#viser.SceneApi.add_batched_axes" title="viser.SceneApi.add_batched_axes"><code class="xref py py-meth docutils literal notranslate"><span class="pre">viser.SceneApi.add_batched_axes()</span></code></a> for coordinate frame instances</p></li>
<li><p>Per-instance transforms (position, rotation, scale)</p></li>
<li><p>Per-instance colors with the <cite>batched_colors</cite> parameter (supports both per-instance and shared colors)</p></li>
<li><p>Level-of-detail (LOD) optimization for performance</p></li>
<li><p>Real-time animation of instance properties</p></li>
</ul>
<p>Batched meshes have some limitations: GLB animations are not supported, hierarchy is flattened, and each mesh in a GLB is instanced separately. However, they excel at rendering thousands of objects efficiently.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example requires external assets. To download them, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>v1.0.5<span class="w"> </span>https://github.com/nerfstudio-project/viser.git
<span class="nb">cd</span><span class="w"> </span>viser/examples
./assets/download_assets.sh
python<span class="w"> </span>01_scene/05_meshes_batched.py<span class="w">  </span><span class="c1"># With viser installed.</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For loading GLB files directly, see <a class="reference internal" href="../../../api/core/scene_api/#viser.SceneApi.add_batched_glb" title="viser.SceneApi.add_batched_glb"><code class="xref py py-meth docutils literal notranslate"><span class="pre">add_batched_glb()</span></code></a>.
For working with trimesh objects, see <a class="reference internal" href="../../../api/core/scene_api/#viser.SceneApi.add_batched_meshes_trimesh" title="viser.SceneApi.add_batched_meshes_trimesh"><code class="xref py py-meth docutils literal notranslate"><span class="pre">add_batched_meshes_trimesh()</span></code></a>.</p>
</div>
<p><strong>Source:</strong> <code class="docutils literal notranslate"><span class="pre">examples/01_scene/05_meshes_batched.py</span></code></p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../_images/01_scene_05_meshes_batched.png"><img alt="Batched mesh rendering" src="../../../_images/01_scene_05_meshes_batched.png" style="width: 100%;" /></a>
</figure>
<section id="code">
<h2>Code<a class="headerlink" href="#code" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="linenos">  2</span>
<span class="linenos">  3</span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="linenos">  4</span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="linenos">  5</span>
<span class="linenos">  6</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">  7</span><span class="kn">import</span><span class="w"> </span><span class="nn">trimesh</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="kn">import</span><span class="w"> </span><span class="nn">viser</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="k">def</span><span class="w"> </span><span class="nf">create_grid_transforms</span><span class="p">(</span>
<span class="linenos"> 13</span>    <span class="n">num_instances</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="linenos"> 15</span>    <span class="n">grid_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_instances</span><span class="p">)))</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span>    <span class="c1"># Create grid positions.</span>
<span class="linenos"> 18</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">grid_size</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">grid_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos"> 19</span>    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">grid_size</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">grid_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos"> 20</span>    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span>    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">grid_size</span> <span class="o">*</span> <span class="n">grid_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos"> 23</span>    <span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="linenos"> 24</span>    <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="linenos"> 25</span>    <span class="n">positions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos"> 26</span>    <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[:</span><span class="n">num_instances</span><span class="p">]</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span>    <span class="c1"># All instances have identity rotation.</span>
<span class="linenos"> 29</span>    <span class="n">rotations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_instances</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos"> 30</span>    <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># w component = 1</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span>    <span class="c1"># Initial scales.</span>
<span class="linenos"> 33</span>    <span class="n">scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 34</span>    <span class="n">scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">scales</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">1.0</span>
<span class="linenos"> 35</span>    <span class="k">return</span> <span class="n">positions</span><span class="p">,</span> <span class="n">rotations</span><span class="p">,</span> <span class="n">scales</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span><span class="k">def</span><span class="w"> </span><span class="nf">generate_per_instance_colors</span><span class="p">(</span>
<span class="linenos"> 39</span>    <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">color_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rainbow&quot;</span>
<span class="linenos"> 40</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos"> 41</span>    <span class="n">n</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span>    <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;rainbow&quot;</span><span class="p">:</span>
<span class="linenos"> 44</span>        <span class="c1"># Rainbow colors based on instance index.</span>
<span class="linenos"> 45</span>        <span class="n">hues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 46</span>        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="linenos"> 47</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hues</span><span class="p">):</span>
<span class="linenos"> 48</span>            <span class="c1"># Convert HSV to RGB (simplified).</span>
<span class="linenos"> 49</span>            <span class="n">c</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Saturation.</span>
<span class="linenos"> 50</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">((</span><span class="n">hue</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>            <span class="k">if</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos"> 53</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 54</span>            <span class="k">elif</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos"> 55</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 56</span>            <span class="k">elif</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos"> 57</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
<span class="linenos"> 58</span>            <span class="k">elif</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos"> 59</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
<span class="linenos"> 60</span>            <span class="k">elif</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos"> 61</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
<span class="linenos"> 62</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 63</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
<span class="linenos"> 64</span>        <span class="k">return</span> <span class="p">(</span><span class="n">colors</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span>    <span class="k">elif</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span>
<span class="linenos"> 67</span>        <span class="c1"># Colors based on position (cosine of position for smooth gradients).</span>
<span class="linenos"> 68</span>        <span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
<span class="linenos"> 69</span>        <span class="k">return</span> <span class="n">colors</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 72</span>        <span class="c1"># Default to white.</span>
<span class="linenos"> 73</span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="k">def</span><span class="w"> </span><span class="nf">generate_shared_color</span><span class="p">(</span><span class="n">color_rgb</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos"> 77</span>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color_rgb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="k">def</span><span class="w"> </span><span class="nf">generate_animated_colors</span><span class="p">(</span>
<span class="linenos"> 81</span>    <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">animation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;wave&quot;</span>
<span class="linenos"> 82</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos"> 83</span>    <span class="n">n</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span>    <span class="k">if</span> <span class="n">animation_mode</span> <span class="o">==</span> <span class="s2">&quot;wave&quot;</span><span class="p">:</span>
<span class="linenos"> 86</span>        <span class="c1"># Wave pattern based on distance from center.</span>
<span class="linenos"> 87</span>        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 88</span>        <span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">distances</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span>
<span class="linenos"> 89</span>        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="linenos"> 90</span>        <span class="n">colors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave</span>  <span class="c1"># Red channel.</span>
<span class="linenos"> 91</span>        <span class="n">colors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">distances</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># Green.</span>
<span class="linenos"> 92</span>        <span class="n">colors</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">distances</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># Blue.</span>
<span class="linenos"> 93</span>        <span class="k">return</span> <span class="p">(</span><span class="n">colors</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>    <span class="k">elif</span> <span class="n">animation_mode</span> <span class="o">==</span> <span class="s2">&quot;pulse&quot;</span><span class="p">:</span>
<span class="linenos"> 96</span>        <span class="c1"># Pulsing color based on position.</span>
<span class="linenos"> 97</span>        <span class="n">pulse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span>
<span class="linenos"> 98</span>        <span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">pulse</span>
<span class="linenos"> 99</span>        <span class="k">return</span> <span class="p">(</span><span class="n">colors</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos">100</span>
<span class="linenos">101</span>    <span class="k">elif</span> <span class="n">animation_mode</span> <span class="o">==</span> <span class="s2">&quot;cycle&quot;</span><span class="p">:</span>
<span class="linenos">102</span>        <span class="c1"># Cycling through hues over time.</span>
<span class="linenos">103</span>        <span class="n">hue_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">%</span> <span class="mf">1.0</span>
<span class="linenos">104</span>        <span class="n">hues</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">hue_shift</span><span class="p">)</span> <span class="o">%</span> <span class="mf">1.0</span>
<span class="linenos">105</span>        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="linenos">106</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hues</span><span class="p">):</span>
<span class="linenos">107</span>            <span class="c1"># Convert HSV to RGB (simplified).</span>
<span class="linenos">108</span>            <span class="n">c</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Saturation.</span>
<span class="linenos">109</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">((</span><span class="n">hue</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">110</span>
<span class="linenos">111</span>            <span class="k">if</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos">112</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">113</span>            <span class="k">elif</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos">114</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">115</span>            <span class="k">elif</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos">116</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
<span class="linenos">117</span>            <span class="k">elif</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos">118</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
<span class="linenos">119</span>            <span class="k">elif</span> <span class="n">hue</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos">120</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
<span class="linenos">121</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">122</span>                <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
<span class="linenos">123</span>        <span class="k">return</span> <span class="p">(</span><span class="n">colors</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos">124</span>
<span class="linenos">125</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">126</span>        <span class="c1"># Default to white.</span>
<span class="linenos">127</span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos">128</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="linenos">131</span>    <span class="c1"># Load and prepare mesh data.</span>
<span class="linenos">132</span>    <span class="n">dragon_mesh</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">load_mesh</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;../assets/dragon.obj&quot;</span><span class="p">))</span>
<span class="linenos">133</span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dragon_mesh</span><span class="p">,</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">Trimesh</span><span class="p">)</span>
<span class="linenos">134</span>    <span class="n">dragon_mesh</span><span class="o">.</span><span class="n">apply_scale</span><span class="p">(</span><span class="mf">0.005</span><span class="p">)</span>
<span class="linenos">135</span>    <span class="n">dragon_mesh</span><span class="o">.</span><span class="n">vertices</span> <span class="o">-=</span> <span class="n">dragon_mesh</span><span class="o">.</span><span class="n">centroid</span>
<span class="linenos">136</span>
<span class="linenos">137</span>    <span class="n">dragon_mesh</span><span class="o">.</span><span class="n">apply_transform</span><span class="p">(</span>
<span class="linenos">138</span>        <span class="n">trimesh</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="linenos">139</span>    <span class="p">)</span>
<span class="linenos">140</span>    <span class="n">dragon_mesh</span><span class="o">.</span><span class="n">apply_translation</span><span class="p">(</span><span class="o">-</span><span class="n">dragon_mesh</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>
<span class="linenos">141</span>
<span class="linenos">142</span>    <span class="n">server</span> <span class="o">=</span> <span class="n">viser</span><span class="o">.</span><span class="n">ViserServer</span><span class="p">()</span>
<span class="linenos">143</span>    <span class="n">server</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">configure_default_lights</span><span class="p">()</span>
<span class="linenos">144</span>    <span class="n">grid_handle</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">add_grid</span><span class="p">(</span>
<span class="linenos">145</span>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span>
<span class="linenos">146</span>        <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="linenos">147</span>        <span class="n">height</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="linenos">148</span>        <span class="n">width_segments</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="linenos">149</span>        <span class="n">height_segments</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="linenos">150</span>    <span class="p">)</span>
<span class="linenos">151</span>
<span class="linenos">152</span>    <span class="c1"># Add GUI controls.</span>
<span class="linenos">153</span>    <span class="n">instance_count_slider</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_slider</span><span class="p">(</span>
<span class="linenos">154</span>        <span class="s2">&quot;# of instances&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="mi">100</span>
<span class="linenos">155</span>    <span class="p">)</span>
<span class="linenos">156</span>
<span class="linenos">157</span>    <span class="n">animate_checkbox</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_checkbox</span><span class="p">(</span><span class="s2">&quot;Animate&quot;</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">158</span>    <span class="n">per_axis_scale_checkbox</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_checkbox</span><span class="p">(</span>
<span class="linenos">159</span>        <span class="s2">&quot;Per-axis scale during animation&quot;</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">160</span>    <span class="p">)</span>
<span class="linenos">161</span>    <span class="n">lod_checkbox</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_checkbox</span><span class="p">(</span><span class="s2">&quot;Enable LOD&quot;</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">162</span>    <span class="n">cast_shadow_checkbox</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_checkbox</span><span class="p">(</span><span class="s2">&quot;Cast shadow&quot;</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">163</span>
<span class="linenos">164</span>    <span class="c1"># Color controls.</span>
<span class="linenos">165</span>    <span class="n">color_mode_dropdown</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_dropdown</span><span class="p">(</span>
<span class="linenos">166</span>        <span class="s2">&quot;Color mode&quot;</span><span class="p">,</span>
<span class="linenos">167</span>        <span class="n">options</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Per-instance&quot;</span><span class="p">,</span> <span class="s2">&quot;Shared&quot;</span><span class="p">,</span> <span class="s2">&quot;Animated&quot;</span><span class="p">),</span>
<span class="linenos">168</span>        <span class="n">initial_value</span><span class="o">=</span><span class="s2">&quot;Per-instance&quot;</span><span class="p">,</span>
<span class="linenos">169</span>    <span class="p">)</span>
<span class="linenos">170</span>
<span class="linenos">171</span>    <span class="c1"># Per-instance color controls.</span>
<span class="linenos">172</span>    <span class="n">per_instance_color_dropdown</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_dropdown</span><span class="p">(</span>
<span class="linenos">173</span>        <span class="s2">&quot;Per-instance style&quot;</span><span class="p">,</span>
<span class="linenos">174</span>        <span class="n">options</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Rainbow&quot;</span><span class="p">,</span> <span class="s2">&quot;Position&quot;</span><span class="p">),</span>
<span class="linenos">175</span>        <span class="n">initial_value</span><span class="o">=</span><span class="s2">&quot;Rainbow&quot;</span><span class="p">,</span>
<span class="linenos">176</span>    <span class="p">)</span>
<span class="linenos">177</span>
<span class="linenos">178</span>    <span class="c1"># Shared color controls.</span>
<span class="linenos">179</span>    <span class="n">shared_color_rgb</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_rgb</span><span class="p">(</span><span class="s2">&quot;Shared color&quot;</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
<span class="linenos">180</span>
<span class="linenos">181</span>    <span class="c1"># Animated color controls.</span>
<span class="linenos">182</span>    <span class="n">animated_color_dropdown</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_dropdown</span><span class="p">(</span>
<span class="linenos">183</span>        <span class="s2">&quot;Animation style&quot;</span><span class="p">,</span>
<span class="linenos">184</span>        <span class="n">options</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Wave&quot;</span><span class="p">,</span> <span class="s2">&quot;Pulse&quot;</span><span class="p">,</span> <span class="s2">&quot;Cycle&quot;</span><span class="p">),</span>
<span class="linenos">185</span>        <span class="n">initial_value</span><span class="o">=</span><span class="s2">&quot;Wave&quot;</span><span class="p">,</span>
<span class="linenos">186</span>    <span class="p">)</span>
<span class="linenos">187</span>
<span class="linenos">188</span>    <span class="c1"># Initialize transforms.</span>
<span class="linenos">189</span>    <span class="n">positions</span><span class="p">,</span> <span class="n">rotations</span><span class="p">,</span> <span class="n">scales</span> <span class="o">=</span> <span class="n">create_grid_transforms</span><span class="p">(</span><span class="n">instance_count_slider</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">190</span>    <span class="n">positions_orig</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">191</span>
<span class="linenos">192</span>    <span class="c1"># Create batched mesh visualization.</span>
<span class="linenos">193</span>    <span class="n">axes_handle</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">add_batched_axes</span><span class="p">(</span>
<span class="linenos">194</span>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;axes&quot;</span><span class="p">,</span>
<span class="linenos">195</span>        <span class="n">batched_positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
<span class="linenos">196</span>        <span class="n">batched_wxyzs</span><span class="o">=</span><span class="n">rotations</span><span class="p">,</span>
<span class="linenos">197</span>        <span class="n">batched_scales</span><span class="o">=</span><span class="n">scales</span><span class="p">,</span>
<span class="linenos">198</span>    <span class="p">)</span>
<span class="linenos">199</span>
<span class="linenos">200</span>    <span class="c1"># Create initial colors based on default mode.</span>
<span class="linenos">201</span>    <span class="n">initial_colors</span> <span class="o">=</span> <span class="n">generate_per_instance_colors</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">color_mode</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
<span class="linenos">202</span>
<span class="linenos">203</span>    <span class="n">mesh_handle</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">add_batched_meshes_simple</span><span class="p">(</span>
<span class="linenos">204</span>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dragon&quot;</span><span class="p">,</span>
<span class="linenos">205</span>        <span class="n">vertices</span><span class="o">=</span><span class="n">dragon_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
<span class="linenos">206</span>        <span class="n">faces</span><span class="o">=</span><span class="n">dragon_mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span>
<span class="linenos">207</span>        <span class="n">batched_positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
<span class="linenos">208</span>        <span class="n">batched_wxyzs</span><span class="o">=</span><span class="n">rotations</span><span class="p">,</span>
<span class="linenos">209</span>        <span class="n">batched_scales</span><span class="o">=</span><span class="n">scales</span><span class="p">,</span>
<span class="linenos">210</span>        <span class="n">batched_colors</span><span class="o">=</span><span class="n">initial_colors</span><span class="p">,</span>
<span class="linenos">211</span>        <span class="n">lod</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<span class="linenos">212</span>    <span class="p">)</span>
<span class="linenos">213</span>
<span class="linenos">214</span>    <span class="c1"># Track previous color mode to avoid redundant disabled state updates.</span>
<span class="linenos">215</span>    <span class="n">prev_color_mode</span> <span class="o">=</span> <span class="n">color_mode_dropdown</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">216</span>
<span class="linenos">217</span>    <span class="c1"># Animation loop.</span>
<span class="linenos">218</span>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">219</span>        <span class="n">n</span> <span class="o">=</span> <span class="n">instance_count_slider</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">220</span>
<span class="linenos">221</span>        <span class="c1"># Update props based on GUI controls.</span>
<span class="linenos">222</span>        <span class="n">mesh_handle</span><span class="o">.</span><span class="n">lod</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span> <span class="k">if</span> <span class="n">lod_checkbox</span><span class="o">.</span><span class="n">value</span> <span class="k">else</span> <span class="s2">&quot;off&quot;</span>
<span class="linenos">223</span>        <span class="n">mesh_handle</span><span class="o">.</span><span class="n">cast_shadow</span> <span class="o">=</span> <span class="n">cast_shadow_checkbox</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">224</span>
<span class="linenos">225</span>        <span class="c1"># Recreate transforms if instance count changed.</span>
<span class="linenos">226</span>        <span class="k">if</span> <span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
<span class="linenos">227</span>            <span class="n">positions</span><span class="p">,</span> <span class="n">rotations</span><span class="p">,</span> <span class="n">scales</span> <span class="o">=</span> <span class="n">create_grid_transforms</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">228</span>            <span class="n">positions_orig</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">229</span>            <span class="n">grid_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
<span class="linenos">230</span>
<span class="linenos">231</span>            <span class="k">with</span> <span class="n">server</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
<span class="linenos">232</span>                <span class="c1"># Update grid size.</span>
<span class="linenos">233</span>                <span class="n">grid_handle</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">grid_handle</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">grid_size</span> <span class="o">+</span> <span class="mi">2</span>
<span class="linenos">234</span>                <span class="n">grid_handle</span><span class="o">.</span><span class="n">width_segments</span> <span class="o">=</span> <span class="n">grid_handle</span><span class="o">.</span><span class="n">height_segments</span> <span class="o">=</span> <span class="n">grid_size</span> <span class="o">+</span> <span class="mi">2</span>
<span class="linenos">235</span>
<span class="linenos">236</span>                <span class="c1"># Update all transforms.</span>
<span class="linenos">237</span>                <span class="n">mesh_handle</span><span class="o">.</span><span class="n">batched_positions</span> <span class="o">=</span> <span class="n">axes_handle</span><span class="o">.</span><span class="n">batched_positions</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">238</span>                    <span class="n">positions</span>
<span class="linenos">239</span>                <span class="p">)</span>
<span class="linenos">240</span>                <span class="n">mesh_handle</span><span class="o">.</span><span class="n">batched_wxyzs</span> <span class="o">=</span> <span class="n">axes_handle</span><span class="o">.</span><span class="n">batched_wxyzs</span> <span class="o">=</span> <span class="n">rotations</span>
<span class="linenos">241</span>                <span class="n">mesh_handle</span><span class="o">.</span><span class="n">batched_scales</span> <span class="o">=</span> <span class="n">axes_handle</span><span class="o">.</span><span class="n">batched_scales</span> <span class="o">=</span> <span class="n">scales</span>
<span class="linenos">242</span>
<span class="linenos">243</span>                <span class="c1"># Colors will be overwritten below; we&#39;ll just put them in a valid state.</span>
<span class="linenos">244</span>                <span class="n">mesh_handle</span><span class="o">.</span><span class="n">batched_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="linenos">245</span>
<span class="linenos">246</span>        <span class="c1"># Generate colors based on current mode.</span>
<span class="linenos">247</span>        <span class="n">color_mode</span> <span class="o">=</span> <span class="n">color_mode_dropdown</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">248</span>
<span class="linenos">249</span>        <span class="c1"># Update disabled state for color controls only when mode changes.</span>
<span class="linenos">250</span>        <span class="k">if</span> <span class="n">color_mode</span> <span class="o">!=</span> <span class="n">prev_color_mode</span><span class="p">:</span>
<span class="linenos">251</span>            <span class="n">per_instance_color_dropdown</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">color_mode</span> <span class="o">!=</span> <span class="s2">&quot;Per-instance&quot;</span>
<span class="linenos">252</span>            <span class="n">shared_color_rgb</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">color_mode</span> <span class="o">!=</span> <span class="s2">&quot;Shared&quot;</span>
<span class="linenos">253</span>            <span class="n">animated_color_dropdown</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">color_mode</span> <span class="o">!=</span> <span class="s2">&quot;Animated&quot;</span>
<span class="linenos">254</span>            <span class="n">prev_color_mode</span> <span class="o">=</span> <span class="n">color_mode</span>
<span class="linenos">255</span>
<span class="linenos">256</span>        <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;Per-instance&quot;</span><span class="p">:</span>
<span class="linenos">257</span>            <span class="c1"># Per-instance colors with different styles.</span>
<span class="linenos">258</span>            <span class="n">per_instance_style</span> <span class="o">=</span> <span class="n">per_instance_color_dropdown</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">259</span>            <span class="n">colors</span> <span class="o">=</span> <span class="n">generate_per_instance_colors</span><span class="p">(</span>
<span class="linenos">260</span>                <span class="n">positions</span><span class="p">,</span> <span class="n">color_mode</span><span class="o">=</span><span class="n">per_instance_style</span>
<span class="linenos">261</span>            <span class="p">)</span>
<span class="linenos">262</span>        <span class="k">elif</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;Shared&quot;</span><span class="p">:</span>
<span class="linenos">263</span>            <span class="c1"># Single shared color for all instances.</span>
<span class="linenos">264</span>            <span class="n">colors</span> <span class="o">=</span> <span class="n">generate_shared_color</span><span class="p">(</span><span class="n">shared_color_rgb</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">265</span>        <span class="k">elif</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;Animated&quot;</span><span class="p">:</span>
<span class="linenos">266</span>            <span class="c1"># Animated colors with time-based effects.</span>
<span class="linenos">267</span>            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="linenos">268</span>            <span class="n">animation_style</span> <span class="o">=</span> <span class="n">animated_color_dropdown</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">269</span>            <span class="n">colors</span> <span class="o">=</span> <span class="n">generate_animated_colors</span><span class="p">(</span>
<span class="linenos">270</span>                <span class="n">positions</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">animation_mode</span><span class="o">=</span><span class="n">animation_style</span>
<span class="linenos">271</span>            <span class="p">)</span>
<span class="linenos">272</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">273</span>            <span class="c1"># Default fallback.</span>
<span class="linenos">274</span>            <span class="n">colors</span> <span class="o">=</span> <span class="n">generate_per_instance_colors</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">color_mode</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
<span class="linenos">275</span>
<span class="linenos">276</span>        <span class="c1"># Animate if enabled.</span>
<span class="linenos">277</span>        <span class="k">if</span> <span class="n">animate_checkbox</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<span class="linenos">278</span>            <span class="c1"># Animate positions.</span>
<span class="linenos">279</span>            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.0</span>
<span class="linenos">280</span>            <span class="n">positions</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">positions_orig</span>
<span class="linenos">281</span>            <span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="linenos">282</span>            <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="linenos">283</span>
<span class="linenos">284</span>            <span class="c1"># Animate scales with wave effect.</span>
<span class="linenos">285</span>            <span class="k">if</span> <span class="n">per_axis_scale_checkbox</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<span class="linenos">286</span>                <span class="n">scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">287</span>                <span class="n">scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<span class="linenos">288</span>                    <span class="p">[</span>
<span class="linenos">289</span>                        <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">scales</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos">290</span>                        <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">scales</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos">291</span>                        <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">scales</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos">292</span>                    <span class="p">],</span>
<span class="linenos">293</span>                    <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">294</span>                <span class="p">)</span>
<span class="linenos">295</span>                <span class="k">assert</span> <span class="n">scales</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="linenos">296</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">297</span>                <span class="n">scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">298</span>                <span class="n">scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">scales</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">1.0</span>
<span class="linenos">299</span>                <span class="k">assert</span> <span class="n">scales</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">n</span><span class="p">,)</span>
<span class="linenos">300</span>
<span class="linenos">301</span>            <span class="c1"># Update colors for animated mode during animation.</span>
<span class="linenos">302</span>            <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;Animated&quot;</span><span class="p">:</span>
<span class="linenos">303</span>                <span class="n">animation_style</span> <span class="o">=</span> <span class="n">animated_color_dropdown</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">304</span>                <span class="n">colors</span> <span class="o">=</span> <span class="n">generate_animated_colors</span><span class="p">(</span>
<span class="linenos">305</span>                    <span class="n">positions</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">animation_mode</span><span class="o">=</span><span class="n">animation_style</span>
<span class="linenos">306</span>                <span class="p">)</span>
<span class="linenos">307</span>
<span class="linenos">308</span>        <span class="c1"># Update mesh properties.</span>
<span class="linenos">309</span>        <span class="k">with</span> <span class="n">server</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
<span class="linenos">310</span>            <span class="n">mesh_handle</span><span class="o">.</span><span class="n">batched_positions</span> <span class="o">=</span> <span class="n">positions</span>
<span class="linenos">311</span>            <span class="n">mesh_handle</span><span class="o">.</span><span class="n">batched_scales</span> <span class="o">=</span> <span class="n">scales</span>
<span class="linenos">312</span>            <span class="n">mesh_handle</span><span class="o">.</span><span class="n">batched_colors</span> <span class="o">=</span> <span class="n">colors</span>
<span class="linenos">313</span>
<span class="linenos">314</span>            <span class="n">axes_handle</span><span class="o">.</span><span class="n">batched_positions</span> <span class="o">=</span> <span class="n">positions</span>
<span class="linenos">315</span>            <span class="n">axes_handle</span><span class="o">.</span><span class="n">batched_scales</span> <span class="o">=</span> <span class="n">scales</span>
<span class="linenos">316</span>
<span class="linenos">317</span>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span>
<span class="linenos">318</span>
<span class="linenos">319</span>
<span class="linenos">320</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">321</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../lighting/">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Lighting and shadows</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../images/">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Images</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/nerfstudio-project/viser" aria-label="GitHub">
            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
        </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Batched mesh rendering</a><ul>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=187304be"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=0729d509"></script>
    </body>
</html>